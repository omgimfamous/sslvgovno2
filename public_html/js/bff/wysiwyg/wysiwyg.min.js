/**
 * Bff.Wysiwyg.js
 * @author Tamaranga | tamaranga.com
 * @version 0.41
 * @modified 22.jun.2015
 */
function multiFile(t){this.listTarget=document.getElementById(t.list),this.count=0,this.id=0,this.name=t.name||"file",this.extensions=t.extensions||!1,this.limit=t.limit||-1,this.delimg=t.delimg||"/img/icon-delete.gif",this.reset=function(){this.count=0,this.id=0,this.listTarget.style.display="none"},this.clearValue=function(t){document.getElementById(t).innerHTML=document.getElementById(t).innerHTML},this.addElement=function(t){"INPUT"==t.tagName&&"file"==t.type&&(t.name=this.name+"_"+this.id++,t.mf=this,t.onchange=function(){if(this.mf.extensions&&!this.mf.checkExt(this.value))return alert("Неверный тип файла"),!1;var e=document.createElement("input");e.type="file",e.className=this.className,this.parentNode.insertBefore(e,this),this.mf.addElement(e),e.size=t.size,this.mf.addListRow(this),this.style.position="absolute",this.style.left="-1000px"},-1!=this.limit&&this.count>=this.limit&&(t.disabled=!0),this.count++,this.current_element=t)},this.checkExt=function(t){try{if(!t)return!0;var e=t.split(/\.+/).pop().toLowerCase();return-1!=this.extensions.search(e)}catch(i){return!0}},this.addListRow=function(t){var e=document.createElement("div");e.className="clear",e.element=t;var i=document.createElement("div");i.className="link left",i.style.margin="3px 5px 0 0",i.style.cursor="pointer",i.innerHTML='<img src="'+this.delimg+'" title="удалить" />';var s=document.createElement("div");s.className="nowrap left",s.style.margin="3px 0 0 0",i.onclick=function(){return this.parentNode.element.parentNode.removeChild(this.parentNode.element),this.parentNode.parentNode.removeChild(this.parentNode),this.parentNode.element.mf.count--,this.parentNode.element.mf.current_element.disabled=!1,this.parentNode.element.mf.count<=1&&(this.parentNode.element.mf.listTarget.style.display="none"),!1},s.innerHTML=t.value.replace(/^([^\\\/]*(\\|\/))*/,""),e.appendChild(i),e.appendChild(s),this.listTarget.appendChild(e),this.listTarget.style.display="block"},this.addElement(document.getElementById(this.name))}var bffWysiwygActive;!function(t){function e(t,i){return this instanceof e?this.init(t,i):new e(t,i)}function i(t,e){this.init(t,e)}t.fn.parentsOrSelf=function(t){var e=this;return 3==e[0].nodeType&&(e=e.parents().slice(0,1)),1==e.filter(t).size()?e:e.parents(t).slice(0,1)},t.fn.bffWysiwyg=function(s,n){var o=navigator.userAgent.toLowerCase();if(/iphone|ipod|ipad|opera mini|opera mobi/i.test(o))return n?new i(this.get(0),s):this.each(function(){new i(this.get(0),s)});if(s=t.extend({css:["blank.css"],path:"/js/bff/wysiwyg/",direction:"ltr",stretch:!1,resize:!0,autogrow:!0,autogrowMax:400,autoSync:!0,reformator:!1,upload:"bffw_upload.php",uploadParams:"",uploadFunction:!1,controls:{},messages:{}},s||{}),s.messages=t.extend(!0,e.MESSAGES,s.messages),s.controls=t.extend(!0,e.TOOLBAR,s.controls),s.controls_hide&&s.controls_hide.length>0){var r=s.controls_hide;for(var a in r)s.controls[r[a]]&&delete s.controls[r[a]]}return s.reformator&&("undefined"==typeof reformator?s.reformator=!1:s.controls.typograph.visible=!0),s.path=s.path||t(t.grep(t("script"),function(t){return t.src&&t.src.match(/wysiwyg?\.js(\?.*)?$/)})).attr("src").replace(/wysiwyg?\.js(\?.*)?$/,""),bff.st.includeJS("core/wysiwyg/htmlparser.js"),n?new e(this.get(0),s):this.each(function(){e(this,s)})},t.extend(e,{BODY:"body",DIV:"div",P:"p",BR:"br",FORMAT_BLOCK:"FormatBlock",MAIN_CONTAINERS:["p","h1","h2","h3","h4","h5","h6","pre","blockquote"],NODE:{ELEMENT:1,ATTRIBUTE:2,TEXT:3},MESSAGES:{nonSelection:"Выделите текст, который бы Вы хотели сделать ссылкой."},TOOLBAR:{bold:{visible:!0,tip:"Полужирный"},italic:{visible:!0,tip:"Курсив"},strikeThrough:{visible:!1,tip:"Перечеркнуть"},underline:{visible:!0,tip:"Подчерктнутый"},title:{visible:!0,dd:!0,tip:"Заголовок",func:function(){return this.dropdownToggle(this.panel.find("a.title"),this.ddTitle)}},fontSize:{visible:!0,dd:!0,tip:"Размер",func:function(){return this.dropdownToggle(this.panel.find("a.fontSize"),this.ddFontSize)}},fontColor:{visible:!0,dd:!0,tip:"Цвет текста",func:function(){return this.dropdownToggle(this.panel.find("a.fontColor"),this.ddFontColor)}},separator00:{visible:!0,separator:!0},justifyLeft:{visible:!0,tip:"Выровнять по левому краю"},justifyCenter:{visible:!0,tip:"Выровнять по центру"},justifyRight:{visible:!0,tip:"Выровнять по правому краю"},justifyFull:{visible:!1,tip:"Justify Full"},separator01:{visible:!0,separator:!0},indent:{visible:!0,tip:"Увеличить отступ"},outdent:{visible:!0,tip:"Уменьшить отступ"},blockquote:{visible:!0,tip:"Цитата",func:function(){this.msie?(this.focus(),this._exec("indent","indent"),this.doc.body.appendChild(this.doc.createElement("br"))):(this._exec("formatBlock","<blockquote>"),this.doc.body.appendChild(this.doc.createElement("br")))}},separator02:{visible:!1,separator:!0},subscript:{visible:!1},superscript:{visible:!1},separator03:{visible:!1,separator:!0},undo:{visible:!1,tip:"Отменить"},redo:{visible:!1,tip:"Повторить"},separator04:{visible:!0,separator:!0},insertOrderedList:{visible:!0,tip:"Нумерованный список"},insertUnorderedList:{visible:!0,tip:"Маркированный список"},insertHorizontalRule:{visible:!1,tip:"Горизонтальный разделитель"},createLink:{visible:!0,tip:"Ссылка",func:function(){var e=this.getSelectionBounds(),i=this.getParentElement("A");if(e.text.length>0||null!=i){var s="(?:(?:https?|ftp)://)?(?:[0-9a-z][\\-0-9a-z]*[0-9a-z]\\.)+[a-z]{2,6}(?::\\d{1,5})?(?:/[?!$.():='+\\-;&~#@,%*\\wА-Яа-я]+)*/?",n=new RegExp("^"+s+"$","i").test(t.trim(e.text)),o=prompt("URL",i?i.href:n?-1==e.text.indexOf("http")?"http://"+t.trim(e.text)+"/":t.trim(e.text):"http://");if(null===o)return;o=t.trim(o),o&&o.length>0&&"http://"!=o?null!=i?t(i).attr("href",o):(this._exec("unlink"),this._exec("createLink",o)):this._exec("unlink")}else!e.text.length&&this.o.messages.nonSelection&&alert(this.o.messages.nonSelection)}},insertImageSimple:{visible:!1,tip:"Изображение",func:function(){if(this.msie)this.focus(),this.doc.execCommand("insertImage",!0,null);else{this.frameWin.focus();var t=prompt("Укажите ссылку на изображение:","http://");t&&t.length>0&&"http://"!=t&&this._exec("insertImage",t)}}},insertImage:{visible:!1,tip:"Изображение",func:function(){this.toggle(!0),this.spanid=this.uniqueStamp(),this.msie&&(this.focus(),this.getSelectionBounds().range.pasteHTML('<span id="span'+this.spanid+'"></span>')),bffWysiwygActive=this;var t=this;t.modalToggle(!0,{ajax:!0,ajaxCache:!0,ajaxUrl:t.o.path+"dialogs/insert_image.htm",ajaxCallback:function(e,i){i.html(e);var s="";t.o.uploadFunction&&(s=t.o.uploadFunction()),t.uploadInit("bffwInsertImageForm",{url:t.o.upload+s,trigger:"bffwUploadBtn"})},busylayer:!0})}},separator07:{visible:!1,separator:!0},cut:{visible:!1},copy:{visible:!1},paste:{visible:!1},separator08:{separator:!0},fullscreen:{visible:!0,tip:"Во весь экран",func:function(){this.fullscreenToggle()}},removeFormat:{visible:!0,tip:"Удалить форматирование",func:function(){this.msie&&this.focus(),this.reformatorEditor!==!1?(this.reformatorEditor.clear(),this.setContent(this.reformatorEditor.wysiwyg.get())):(this._exec("removeFormat",[]),this._exec("unlink",[]))}},typograph:{visible:!1,tip:"Типографировать",func:function(){if(this.reformatorEditor!==!1){var t=this.getContent();t=reformator.typograph.process(t),this.setContent(t),this.textarea.val(t),this.reformatorEditor.wysiwyg.set(t)}}},html:{visible:!0,tip:"Код",func:function(){this.toggle(!this.visual)}},tableRemove:{visible:1,tip:"Удалить таблицу",className:"tableRemove hidden",func:function(){this.tableActions("table-remove")}},tableRowBefore:{visible:1,tip:"Вставить строку перед",className:"tableRowBefore hidden",func:function(){this.tableActions("row-before")}},tableRowAfter:{visible:1,tip:"Вставить строку после",className:"tableRowAfter hidden",func:function(){this.tableActions("row-after")}},tableColumnBefore:{visible:1,tip:"Вставить столбец перед",className:"tableColumnBefore hidden",func:function(){this.tableActions("column-before")}},tableColumnAfter:{visible:1,tip:"Вставить столбец после",className:"tableColumnAfter hidden",func:function(){this.tableActions("column-after")}},tableRowRemove:{visible:1,tip:"Удалить строку",className:"tableRowRemove hidden",func:function(){this.tableActions("row-remove")}},tableColumnRemove:{visible:1,tip:"Удалить столбец",className:"tableColumnRemove hidden",func:function(){this.tableActions("column-remove")}}}}),e.prototype={id:0,textarea:null,box:null,frame:null,frameWin:null,doc:null,visual:!0,fullscreen:!1,sel:!1,reformatorEditor:!1,focus:function(e){if(!this.visual)return void this.textarea.focus();if(e){var i=this;if(this.msie){var s=this.getSelectionBounds();setTimeout(function(){s.range&&s.range.select()},0)}else setTimeout(function(){i.frameWin.focus()},0)}else t(this.doc.body).focus()},focusElement:function(t,e){if(void 0==e&&(e=!1),this.frameWin.getSelection){var i=this.frameWin.getSelection(),s=this.doc.createRange();i.removeAllRanges(),s.selectNodeContents(t),s.collapse(e),i.addRange(s)}else{var s=this.doc.body.createTextRange();if(3!=t.nodeType)try{s.moveToElementText(t),s.collapse(e),s.select()}catch(n){}}},init:function(e,i){var s=this;this.id=t(e).attr("id"),_bffwysiwyg[this.id]=this,this.textarea=t(e),this.o=i||{};var l=navigator.userAgent.toLowerCase();if(this.opera=/opera/i.test(l),this.msie=!this.opera&&/msie/i.test(l)||/trident/i.test(l),this.msie6=!this.opera&&/msie 6/i.test(l),this.msie8=!this.opera&&/msie 8/i.test(l),this.mozilla=/firefox/i.test(l),this.chrome=/chrome/i.test(l),this.safari=!/chrome/i.test(l)&&/webkit|safari|khtml/i.test(l),t.data(e,"wysiwyg",this),this.width=t(e).css("width"),/px/.test(this.width)&&(this.width=parseInt(this.width)),this.height=e.height||e.clientHeight||parseInt(t(e).css("height")),"textarea"==e.nodeName.toLowerCase()){this.frame=t('<iframe frameborder="0" marginheight="0" marginwidth="0" scrolling="auto" vspace="0" hspace="0"                                     id="bffw_frame_'+this.id+'" class="bffw-frame" style="height: '+this.height+'px;" tabindex="'+t(e).attr("tabindex")+'">                                    </iframe>').css({minHeight:this.height}).get(0),this.panel=t('<ul class="panel"></ul>'),this.buildToolbar(),this.box=t('<div id="bffw_box_'+this.id+'" style="width: '+(this.width>0&&!i.stretch?this.width+"px":"100%")+'; position:relative;" class="bffw-box"></div>'),this.textarea.hide().css({width:"100%",height:this.height}).attr("spellcheck",!1),this.box.insertAfter(this.textarea),this.box.append(this.panel).append(t('<div class="bffw-frame-box"></div>').append(this.frame).append(this.textarea)).append('<iframe id="bffw-dd-title'+s.id+'" rel="'+s.id+'" class="bffw-dropdown" scrolling="no" height="105" frameborder="0" width="50" style="display:none;" marginheight="0" marginwidth="0" src="'+i.path+'/dialogs/title.htm"></iframe>').append('<iframe id="bffw-dd-fontcolor'+s.id+'" rel="'+s.id+'" class="bffw-dropdown" scrolling="no" height="100" frameborder="0" width="150" style="display:none;" marginheight="0" marginwidth="0" src="'+i.path+'/dialogs/palette.htm"></iframe>').append('<iframe id="bffw-dd-fontsize'+s.id+'" rel="'+s.id+'" class="bffw-dropdown" scrolling="no" height="105" frameborder="0" width="165" style="display:none;" marginheight="0" marginwidth="0" src="'+i.path+'/dialogs/fontsize.htm"></iframe>'),this.o.resize&&(this.resizer=t('<div id="bffw_resize_'+this.id+'" class="bffw-resize"><div></div></div>'),t(this.box).append(this.resizer),this.resizer.mousedown(function(t){s.initResize(t)})),this.ddFontColor=t("#bffw-dd-fontcolor"+s.id),this.ddFontSize=t("#bffw-dd-fontsize"+s.id),this.ddTitle=t("#bffw-dd-title"+s.id),this.initialContent=t(e).val(),this.msie?t.extend(this,n):this.mozilla?t.extend(this,o):this.opera?t.extend(this,r):(this.safari||this.chrome)&&t.extend(this,a),this.initIframe(),this.textarea.focus(function(){}),this.o.autoSync&&(t(this.doc).bind("keyup",function(){s.sync()}),t(this.textarea).bind("keyup",function(t){s.sync()})),t(this.doc.body).css("min-height",this.height);var h=t(e).closest("form");h.submit(function(){s.sync()}).bind("reset",function(){s.setContent(s.initialContent,!1),s.toVisual()})}},initIframe:function(){var e=this,i="";this.o.css&&("string"==typeof this.o.css?i+="<style>"+this.o.css+"</style>":t.each(this.o.css,function(){i+='<link rel="stylesheet" type="text/css" href="'+e.o.path+this+'" />'})),this.frameWin=this.frame.window?this.frame.window:this.frame.contentWindow,this.doc=this.frame.contentWindow?this.frame.contentWindow.document:this.frame.contentDocument?this.frame.contentDocument:this.frame.document,this.doc.open(),this.doc.write('<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">                    <html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ru" lang="ru"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">                    '+i+'</head><body class="bffw_body">'+bffWysiwygProtectedSource.Protect(this.initialContent)+"</body></html>"),this.doc.close(),this.doc.contentEditable="true",this.doc.onpaste=function(){e.onPaste()},this._init(this),t("html",this.doc).attr("dir",this.o.direction),this.msie&&setTimeout(function(){t(e.doc.body).css({border:"none"})},0),t(this.doc).bind("mouseup keyup",function(t){e.updateToolbar(),e.dropdownsHide(),86==t.keyCode&&(t.ctrlKey||t.metaKey)&&e.onPaste()}).bind("keydown",function(t){return e.fullscreen&&9==t.keyCode?(e._exec("indent"),!1):void 0}),this.o.autogrow&&(this.msie||this.agInit()),e.o.reformator&&(e.reformatorEditor===!1&&(reformator.append(this.textarea.get(0),{bar:!1}),reformator.children.length>0&&(e.reformatorEditor=reformator.children[reformator.children.length-1],e.reformatorEditor.set_autoformat(!1),t(e.textarea).hide(),t(e.frame).after(e.textarea))),e.reformatorEditor!==!1&&e.reformatorEditor.set_active(e.visual))},reinitIframe:function(){this.initialContent=this.getContent(),this.initIframe()},uniqueStamp:function(){return Math.floor(99999*Math.random())},getContent:function(){if(!this.doc)return"";this.cleanExtraBRs(this.doc.body);var e=t(this.doc.body).html()||"";return this.visual&&(e=this.sanitizeHTML(e)),this.chrome&&(e=e.replace(/^&nbsp;*((\S+\s*)*)/,"$1")),bffWysiwygProtectedSource.Revert(e)},_firstPreview:!0,getContentPreview:function(){return this.doc?(this._firstPreview&&(this.setContent(this.sanitizeHTML(bffWysiwygProtectedSource.Protect(this.textarea.val()))),this._firstPreview=!1),this.visual||this.toggle(!0),this.cleanExtraBRs(this.doc.body),t(this.doc.body).html()||""):""},getContentText:function(){if(!this.doc)return"";this.visual||this.toggle(!0);var e=t(this.doc.body).html()||"";return e.replace(/<(?:.|\s)*?>/g,"").replace(/\s/gi,"").replace(/&nbsp;/g,"")},getContentDim:function(){return{width:t(this.doc).width(),height:t(this.doc).height()}},setContent:function(e,i){i?t(this.doc.body).append(e):t(this.doc.body).html(e)},_toggles:!1,toggle:function(e){this.doc&&!this._toggles&&e!=this.visual&&(this._toggles=!0,this.sync(),e?(this.textarea.hide(),t(this.frame).show(),t("a:not(.html)",this.panel).removeClass("disabled")):(t(this.frame).hide(),this.textarea.show(),t("a:not(.html)",this.panel).addClass("disabled"),this.o.autogrow&&this.agCheck()),this.reformatorEditor!==!1&&this.reformatorEditor.set_active(e),this.visual=e,e?t(".html",this.panel).removeClass("active"):t(".html",this.panel).addClass("active"),this._toggles=!1)},sync:function(){if(this.visual){var t=this.getContent();this.reformatorEditor!==!1&&this.reformatorEditor.wysiwyg.set(t),this.textarea.val(t)}else{var t=this.sanitizeHTML(this.textarea.val());this.setContent(bffWysiwygProtectedSource.Protect(t)),this.reformatorEditor!==!1&&this.reformatorEditor.wysiwyg.set(t)}},sanitizeHTML:function(t){try{return HTMLtoXML(this.clearWord(t))}catch(e){return t}},clearWord:function(e){if(this.clearWordNeeded(e)){e=e.replace(/<(\w[^>]*) language=([^ |>]*)([^>]*)/gi,"<$1$3"),e=e.replace(/<FONT\s*>([\s\S]*?)<\/FONT>/gi,"$1");var i=[];i.push(/(MsoNormal|MsoPlainText)/g),i.push(/<style[^>]*>[\s\S]*?<\/style[^>]*>/gi),i.push(/<(?:META|LINK)[^>]*>\s*/gi),i.push(/<w:[^>]*>[\s\S]*?<\/w:[^>]*>/gi),i.push(/<\\?\?xml[^>]*>/gi),i.push(/<\/?\w+:[^>]*>/gi),i.push(/ v:.*?=".*?"/g),i.push(/\s*mso-[^:]+:[^;"]+;?/gi),i.push(/\s*(style|class)="\s*"/gi),i.push(/<!--\[if[^<]*?\][\S\s]*?\[endif\]-->/gi),i.push(/<!--[^<>]*-->/gi),t.each(i,function(){e=e.replace(this,"")})}return e},clearWordNeeded:function(t){var e=/<\w[^>]*(( class="?MsoNormal"?)|( class="?MsoPlainText"?)|(="mso-))/gi;return e.test(t)},toVisual:function(){this.visual?this.sync():this.toggle(!0)},NonEmptyBlockElements:{p:1,div:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,address:1,pre:1,ol:1,ul:1,li:1,td:1,th:1},cleanExtraBRs:function(e){for(var i=e.firstChild;i;)this.cleanExtraBRs(i),i=i.nextSibling;if(e&&e.tagName){var s=e.tagName.toLowerCase();if(Boolean(this.NonEmptyBlockElements[s])&&s&&"pre"!=s){var n=e.lastChild;n&&1==n.nodeType&&"BR"==n.nodeName&&t(n).replaceWith("&#160;")}}},_paste_process:!1,onPaste:function(){var t=this;t._paste_process||(t._paste_process=!0,setTimeout(function(){var e=t.getContent();t.clearWordNeeded(e)&&(e=t.clearWord(e),t.setContent(e)),t.reformatorEditor!==!1&&(t.reformatorEditor.clear(),e=t.reformatorEditor.wysiwyg.get(),e=reformator.typograph.process(e),t.setContent(e)),t._paste_process=!1},400))},fullscreen_win_state:{},fullscreenToggle:function(){if(this.fullscreen===!1){this.fullscreen=!0,this.resizer&&this.resizer.hide(),this.height=t(this.frame).css("height"),this.width=this.box.width()+"px",this.box.css({position:"absolute",top:0,left:0,zIndex:1e3}).after('<span id="fullscreen_'+this.id+'"></span>'),this.fullscreen_win_state={scroll_top:t(window).scrollTop(),body_height:t(document.body).height()},t(document.body).css({overflow:"hidden",height:"1px"}),t(document).scrollTop(0,0),this.fullscreenResize();var e=this;t(window).resize(function(){e.fullscreenResize()})}else{this.fullscreen=!1;var e=this;t(window).unbind("resize",function(){e.fullscreenResize()}),t(document.body).css({overflow:"",height:this.fullscreen_win_state.body_height}),t(document).scrollTop(this.fullscreen_win_state.scroll_top,0),this.resizer&&this.resizer.show(),this.box.css({position:"relative",top:"auto",left:"auto",zIndex:1,width:this.width}),t("#fullscreen_"+this.id).remove(),t(this.frame).css("height",this.height),this.textarea.css("height",this.height)}t("a.fullscreen",this.panel).toggleClass("active")},fullscreenResize:function(){if(this.fullscreen!==!1){var e=t(window).height()-42;this.box.width(t(window).width()),t(this.frame).height(e),this.textarea.height(e)}},initResize:function(e){var i=this;e.preventDefault(),this.splitter=e.target,this.visual?(this.element_resize=t(this.frame),this.element_resize.get(0).style.visibility="hidden",this.element_resize_parent=this.textarea):(this.element_resize=this.textarea,this.element_resize_parent=t(this.frame)),this.stopResizeHdl=function(t){i.stopResize(t)},this.startResizeHdl=function(t){i.startResize(t)},this.resizeHdl=function(t){i.resize(t)},t(document).mousedown(this.startResizeHdl),t(document).mouseup(this.stopResizeHdl),t(this.splitter).mouseup(this.stopResizeHdl),this.null_point=!1,this.h_new=!1,this.h=this.element_resize.height()},startResize:function(){t(document).mousemove(this.resizeHdl)},resize:function(t){t.preventDefault();var e=t.pageY;0==this.null_point&&(this.null_point=e),0==this.h_new&&(this.h_new=this.element_resize.height());var i=this.h_new+e-this.null_point-10;return 30>=i?!0:void(i>=0&&(this.element_resize.get(0).style.height=i+"px",this.element_resize_parent.get(0).style.height=i+"px"))},resizeTo:function(t,e){this.element_resize.get(0).style.height=e+"px",this.element_resize_parent.get(0).style.height=e+"px",this.element_resize.get(0).style.width=t+"px",this.element_resize_parent.get(0).style.width=t+"px"},stopResize:function(e){t(document).unbind("mousemove",this.resizeHdl),t(document).unbind("mousedown",this.startResizeHdl),t(document).unbind("mouseup",this.stopResizeHdl),t(this.splitter).unbind("mouseup",this.stopResizeHdl),this.element_resize.get(0).style.visibility="visible"},agInit:function(){var e=this;this.agCheckHdl=function(t){e.fullscreen||e.agCheck(t)},this.agMinHeight=this.frame.offsetHeight,t(this.doc).keyup(this.agCheckHdl)},agCheck:function(){if(this.doc){var e=this.agGetEffectiveHeight(this.doc.body.clientHeight);this.frame.style.height=e+"px",t(this.textarea).height(e)}},agGetEffectiveHeight:function(t){var e=this.o.autogrowMax;return t<this.agMinHeight?t=this.agMinHeight:e&&e>0&&t>e?t=e:t+=30,t},getSelectionBounds:window.getSelection?function(t){var e,i,s,n,o;return i=this.frameWin.getSelection(),t?i:(e=i.rangeCount>0?i.getRangeAt(0).cloneRange():this.doc.createRange(),s=e.commonAncestorContainer||null,n=e.startContainer,o=e.endContainer,3==n.nodeType&&(n=n.parentNode),3==o.nodeType&&(o=o.parentNode),{range:e,text:i.toString(),selection:i,root:n==o?n:s,start:n,end:o})}:function(t){if(t)return this.doc.selection;var e,i,s,n,o,r=function(t){var i=e.duplicate();return i.collapse(t),i.parentElement()};return e=this.doc.selection?this.doc.selection.createRange():null,s=e&&e.parentElement?e.parentElement():null,n=r(!0),o=r(!1),i=e.text,{range:e,text:i,root:n==o?n:s,start:n,end:o}},getSelectionContaining:function(e,i){var e=e||this.getSelectionBounds(),s=function(t,e){for(;"BODY"!=t.tagName;){if(e(t))return t;t=t.parentNode}return null};if(window.getSelection){var n=e.range.commonAncestorContainer;if(n.childElementCount>0){var o=null;return t.each(n.children,function(t,e){return i(e)?(o=e,!1):void 0}),o}return s(e.range.commonAncestorContainer,i)}if("Control"==e.type){if(1!=e.range.length)return null;var o=e.range.item(0)}else var o=e.range.parentElement();return s(o,i)},getParentElement:function(){this.frameWin.focus();for(var t=!1,e=this.getSelectionBounds(),i=e.root;i&&"BODY"!=i.nodeName&&!t;)for(var s=0;s<arguments.length;s++){if(arguments[s].toUpperCase()==i.nodeName.toUpperCase()){t=!0;break}t||(i=i.parentNode)}return i&&"BODY"==i.nodeName&&(i=null),i},insertHtml:function(t,e){t&&t.length>0&&this._exec("insertHTML",this.sanitizeHTML(t)),e&&this.focus(!0)},setTitle:function(t){this.msie&&this.sel.range.select(),this._exec("formatBlock",t>0?"<h"+t+">":"<p>"),this.dropdownsHide(),this.focus(!0),this.o.autoSync&&this.sync()},setFontColor:function(t){this.msie&&this.sel.range.select(),this._exec("ForeColor",t),this.dropdownsHide(),this.focus(!0),this.o.autoSync&&this.sync()},setFontSize:function(t){this.msie&&this.sel.range.select(),this._exec("FontSize",t),this.dropdownsHide(),this.focus(!0),this.o.autoSync&&this.sync()},dropdownToggle:function(t,e){if(this.msie&&(this.sel=this.getSelectionBounds()),e.is(":hidden")){this.dropdownsHide();var i=t.parent().position();e.css({left:i.left+2,top:i.top+18}).show()}else this.dropdownsHide()},dropdownsHide:function(){t(".bffw-dropdown").hide()},modalToggle:function(t,e){return t&&this.dropdownsHide(),utils.popupErr("",t,e)},uploadInit:function(e,i){if(this.uploadOpts={url:!1,success:!1,start:!1,trigger:!1,auto:!1,input:!1},t.extend(this.uploadOpts,i),e=t("#"+e),e.length)if("INPUT"==e.get(0).tagName?(this.uploadOpts.input=e,this.uploadOpts.form=t(e.get(0).form)):this.uploadOpts.form=e,this.uploadOpts.formAction=this.uploadOpts.form.attr("action"),this.uploadOpts.auto)this.uploadOpts.form.submit(function(){return!1}),this.uploadSubmit();else if(this.uploadOpts.trigger){var s=this;t("#"+this.uploadOpts.trigger).click(function(){s.uploadSubmit()})}},uploadSubmit:function(){return this.uploadOpts.input||""==t("#bffw_image_link").val()?void this.uploadForm(this.uploadOpts.form,this.uploadFrame()):void this.imageUploadCallback('{"error": 0, "url":"'+t("#bffw_image_link").val()+'"}')},uploadFrame:function(){this.uploadID="f"+Math.floor(99999*Math.random());var e=document.createElement("div"),i='<iframe style="display:none" src="about:blank" id="'+this.uploadID+'" name="'+this.uploadID+'"></iframe>';e.innerHTML=i,document.body.appendChild(e),this.uploadOpts.start&&this.uploadOpts.start();var s=this;return t("#"+this.uploadID).load(function(){s.uploadLoaded()}),this.uploadID},uploadForm:function(e,i){if(this.uploadOpts.input){var s="bffwUploadForm"+this.uploadID,n="bffwUploadFile"+this.uploadID,o=t('<form action="'+this.uploadOpts.url+'" method="POST" target="'+i+'" name="'+s+'" id="'+s+'" enctype="multipart/form-data"></form>'),r=this.uploadOpts.input,a=t(r).clone();t(r).attr("id",n).before(a).appendTo(o),o.css({position:"absolute",top:"-1200px",left:"-1200px"}).appendTo("body").submit()}else e.attr({target:i,method:"POST",enctype:"multipart/form-data",action:this.uploadOpts.url}).submit()},uploadLoaded:function(){var e=t("#"+this.uploadID);if(e.contentDocument)var i=e.contentDocument;else if(e.contentWindow)var i=e.contentWindow.document;else var i=window.frames[this.uploadID].document;return"about:blank"==i.location.href?!0:(this.uploadOpts.success&&this.uploadOpts.success(i.body.innerHTML),this.imageUploadCallback(i.body.innerHTML),void this.uploadOpts.form.attr({action:this.uploadOpts.formAction,target:""}))},imageUploadCallback:function(e){if(e=t.parseJSON(e),0==e)return void alert("Ошибка загрузки файла");if(0!=e.error&&7!=e.error)return void alert("Ошибка: "+e.errormsg);var i=t("#bffw_image_alt").val();i=i?' alt="'+i+'"':"";var s=bffWysiwygActive;s.focus(!0);var n=s.uniqueStamp(),o=t("#bffw_image_align");if(o.length){var r=o.val();r="left"==r||"right"==r?'align="'+r+'" style="margin-'+("right"==r?"left":"right")+': 10px; margin-bottom: 5px;" ':"";var a="<img "+i+' id="'+n+'" src="'+e.url+'" '+r+" />"}else var a="<img "+i+' id="'+n+'" src="'+e.url+'" />';s.msie?(t(s.doc.getElementById("span"+s.spanid)).after(a),t(s.doc.getElementById("span"+s.spanid)).remove()):s._exec("inserthtml",a);var l=t("#"+n,s.doc.body);l.length&&l.attr("src",e.url).removeAttr("id"),7==e.error?alert("Ошибка: "+e.errormsg):s.modalToggle(!1)},buildToolbar:function(){this.toolbarCmds={};for(var t in this.o.controls){var e=this.o.controls[t];e.separator?e.visible!==!1&&this.appendToolbarSeparator():e.visible&&this.appendToolbarCommand(e.command||t,e.className||e.command||t||"empty",e)}},appendToolbarCommand:function(e,i,s){var n=this,o=s.arguments||[];(this.toolbarCmds[e]=t('<a class="'+(i||e)+'"><!-- --></a>')).get(0).unselectable="on",t("<li></li>").append(this.toolbarCmds[e]).mousedown(function(){return n.visual||"html"==e?(s.dd||n.dropdownsHide(),s.func?s.func.apply(n):(n._exec(e,o),n.o.autoSync&&n.sync()),n.focus(!0),void n.updateToolbar()):void n.toggle(!0)}).attr("title",s.tip||"").appendTo(this.panel)},appendToolbarSeparator:function(){t('<li class="separator"></li>').appendTo(this.panel)},updateToolbar:function(){if(this.visual){var t,e=["bold","italic","underline","justifyLeft","justifyCenter","justifyRight","insertOrderedList","insertUnorderedList"];try{for(var i=0;i<e.length;i++)t=e[i],this.doc.queryCommandState(t)?this.toolbarCmds[t].addClass("active"):this.toolbarCmds[t].removeClass("active")}catch(s){}for(var n=["tableRemove","tableRowBefore","tableRowAfter","tableColumnBefore","tableColumnAfter","tableRowRemove","tableColumnRemove"],o=this.getParentElement("TABLE"),i=0;i<n.length;i++)t=n[i],o?this.toolbarCmds[t].removeClass("disabled hidden"):this.toolbarCmds[t].addClass("disabled")}}};var s={Elements:[],AddElement:function(t){var e=this.Elements.length;return this.Elements[e]=t,e},RemoveElement:function(t){var e=this.Elements[t];return this.Elements[t]=null,e},Reset:function(){for(var t=0;t<this.Elements.length;)this.Elements[t++]=null;this.Elements.length=0},ToHtml:function(){for(var t=0;t<this.Elements.length;t++)this.Elements[t]="<div>&nbsp;"+this.Elements[t].outerHTML+"</div>",this.Elements[t].isHtml=!0}};bffWysiwygProtectedSource={},bffWysiwygProtectedSource._CodeTag=(new Date).valueOf(),bffWysiwygProtectedSource.RegexEntries=[/<!--[\s\S]*?-->/g,/<iframe[\s\S]*?<\/iframe>/gi,/<script[\s\S]*?<\/script>/gi,/<noscript[\s\S]*?<\/noscript>/gi],bffWysiwygProtectedSource.Add=function(t){this.RegexEntries.push(t)},bffWysiwygProtectedSource.Protect=function(t){function e(t){var e=s.AddElement(t);return"<!--{"+i+e+"}-->"}for(var i=this._CodeTag,n=0;n<this.RegexEntries.length;n++)t=t.replace(this.RegexEntries[n],e);return t},bffWysiwygProtectedSource.Revert=function(t,e){function i(t,i,n){var o=e?s.RemoveElement(n):s.Elements[n];return bffWysiwygProtectedSource.Revert(o,e)}var n=new RegExp("(<|&lt;)!--\\{"+this._CodeTag+"(\\d+)\\}--(>|&gt;)","g");return t.replace(n,i)};var n={_init:function(t){this.doc.body.onfocus=function(){t.doc.designMode="on",t.doc=t.frame.contentWindow.document},this.doc.onbeforedeactivate=function(){t.saveCaret()},this.doc.onkeyup=function(){t.saveCaret(),t.keyup()},this.doc.onclick=function(){t.saveCaret()},this.doc.designMode="on";try{this.doc=this.frame.contentWindow.document}catch(e){}},_exec:function(t,e){return"insertHTML"==t?(this.focus(),void this.doc.selection.createRange().pasteHTML(e)):void(e?this.doc.execCommand(t,!1,e):this.doc.execCommand(t))},selected:function(){var t=this.frame.contentWindow.document.caretPos;return null!=t&&void 0!=t.parentElement?t.parentElement():void 0},saveCaret:function(){this.doc.caretPos=this.doc.selection.createRange()},keyup:function(){this._selected_image=null}},o={_init:function(e){this.enableDesignMode(),t(this.doc).bind("keydown",function(t){return e.keydown(t)}).bind("keyup",function(t){return e.keyup(t)}).bind("focus",function(){return e.enableDesignMode()})},_exec:function(t,i){if(!this.selected())return!1;i?this.doc.execCommand(t,"",i):this.doc.execCommand(t,"",null);var s=this.selected();s.tagName.toLowerCase()==e.BODY&&this._exec(e.FORMAT_BLOCK,e.P)},selected:function(){var t=this.getSelectionBounds(!0),e=t.focusNode;return e?"#text"==e.nodeName?e.parentNode:e:null},keydown:function(t){if((t.ctrlKey||t.metaKey)&&13!=t.keyCode){if(66==t.keyCode)return this._exec("Bold"),!1;if(73==t.keyCode)return this._exec("Italic"),!1;if(85==t.keyCode)return this._exec("Underline"),!1}else if(13==t.keyCode&&!t.shiftKey){var i=this.selected();if(i){var s=i.tagName.toLowerCase();("pre"==s||s==e.BODY)&&(t.preventDefault(),this._exec("insertHTML","<p></p>"))}}},keyup:function(i){if(this._selected_image=null,13!=i.keyCode||i.shiftKey){if(8!=i.keyCode&&17!=i.keyCode&&46!=i.keyCode&&224!=i.keyCode&&!i.metaKey&&!i.ctrlKey){var s=this.selected(),n=s.tagName.toLowerCase();("strong"==n||"b"==n||"em"==n||"i"==n||"sub"==n||"sup"==n||"a"==n)&&(n=s.parentNode.tagName.toLowerCase()),n==e.BODY&&this._exec(e.FORMAT_BLOCK,e.P)}}else t(this.doc.body).children(e.BR).remove()},enableDesignMode:function(){try{"off"==this.doc.designMode&&(this.doc.designMode="on",this.doc.execCommand("styleWithCSS","",!1)),this.doc.execCommand("EnableInlineTableEditing",!1,!1)}catch(t){}}},r={_init:function(e){this.doc.designMode="on",t(this.doc).bind("keydown",function(t){e.keydown(t)}).bind("keyup",function(t){e.keyup(t)})},_exec:function(t,e){e?this.doc.execCommand(t,!1,e):this.doc.execCommand(t)},selected:function(){var t=this.getSelectionBounds(!0),e=t.focusNode;return e?"#text"==e.nodeName?e.parentNode:e:null},keydown:function(i){var s=this.getSelectionBounds(!0);startNode=s.start,t(startNode).parentsOrSelf(e.MAIN_CONTAINERS.join(","))[0]||t(startNode).parentsOrSelf("li")||13==i.keyCode||37==i.keyCode||38==i.keyCode||39==i.keyCode||40==i.keyCode||8==i.keyCode||46==i.keyCode||this._exec(e.FORMAT_BLOCK,e.P)},keyup:function(t){this._selected_image=null}},a={_init:function(e){this.doc.designMode="on",t(this.doc).bind("keydown",function(t){e.keydown(t)}).bind("keyup",function(t){e.keyup(t)})},_exec:function(t,i){if(!this.selected())return!1;i?this.doc.execCommand(t,"",i):this.doc.execCommand(t,"",null);var s=this.selected();s&&s.tagName.toLowerCase()==e.BODY&&this._exec(e.FORMAT_BLOCK,e.P)},selected:function(){var t=this.getSelectionBounds(!0),e=t.focusNode;return e?"#text"==e.nodeName?e.parentNode:e:null},keyup:function(i){if(this._selected_image=null,13!=i.keyCode||i.shiftKey||t(this.doc.body).children(e.BR).remove(),
13==i.keyCode&&i.shiftKey&&!this.chrome&&this._exec("InsertLineBreak"),8!=i.keyCode&&17!=i.keyCode&&46!=i.keyCode&&224!=i.keyCode&&!i.metaKey&&!i.ctrlKey){var s=this.selected(),n=s.tagName.toLowerCase();("strong"==n||"b"==n||"em"==n||"i"==n||"sub"==n||"sup"==n||"a"==n||"span"==n)&&(n=s.parentNode.tagName.toLowerCase()),(n==e.BODY||n==e.DIV)&&this._exec(e.FORMAT_BLOCK,e.P)}},keydown:function(t){if((t.ctrlKey||t.metaKey)&&13!=t.keyCode){if(66==t.keyCode)return this._exec("Bold"),!1;if(73==t.keyCode)return this._exec("Italic"),!1;if(85==t.keyCode)return this._exec("Underline"),!1}else if(13==t.keyCode&&!t.shiftKey){var i=this.selected();i&&"pre"==i.tagName.toLowerCase()&&(t.preventDefault(),this._exec(e.FORMAT_BLOCK,e.P))}}};i.prototype={txt:null,init:function(e,i){this.txt=t(e),this.txt.after('<input type="hidden" name="mobile" value="1" />'),this.txt.width(this.txt.width()-5),this.getContent=this.getContentText;var s=this.txt.height();this.txt.css("minHeight",s),this.txt.autogrow({minHeight:s,lineHeight:9})},getContentPreview:function(){var t=this.txt.val();return t.replace(/([^>])\n/g,"$1<br/>")},getContentText:function(){return this.txt.val()},getContentDim:function(){return{width:t(this.txt).width(),height:t(this.txt).height()}},setContent:function(t,e){this.txt.val(e?t+this.txt.val():t)},insertHtml:function(t,e){e!==!1&&(t=t.replace(/<\/?[^>]+>/gi,""));var i=this.txt.get(0);if(-1==navigator.userAgent.indexOf("Opera")&&i.focus(),document.selection)document.selection.createRange().text=t+" ";else if(i.selectionStart||0==i.selectionStart){var s=i.value.substring(0,i.selectionStart);i.value=s+t+i.value.substring(i.selectionEnd,i.value.length);var n=0;n?i.selectionStart=i.selectionEnd=s.length+n:(n=s.length+t.length,i.selectionStart=i.selectionEnd=n)}else i.value+=t},focus:function(){this.txt.focus()},toggle:function(){},toVisual:function(){},sync:function(){}}}(jQuery),_bffwysiwyg=[];