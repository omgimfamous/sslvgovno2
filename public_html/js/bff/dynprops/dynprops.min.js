/**
 * Bff.Dynprops.js (bff\db\Dynprops component)
 * @author Tamaranga | tamaranga.com
 * @version 1.821
 * @modified 05.02.2015
 */
var bffDynprops=function(){function e(e){return l(e,[d.select,d.multipleselect,d.radiogroup,d.checkboxgroup])}function t(e){return!l(e,[d.text,d.textarea,d.wysiwyg])}function a(a,o,p){function u(t){var l=$("select.dynprop-type-select",D),n="",r=0;if(A){r=intval(t.type),e(r)||(l.prop("disabled",!0),l.after('<input type="hidden" name="dynprop[type]" value="'+r+'" />'));var i=function(e,t){if(e==t||!o.types_allowed.length)return!0;for(var a in o.types_allowed)if(o.types_allowed.hasOwnProperty(a)&&o.types_allowed[a]==e)return!0;return!1};switch(r){case d.select:case d.radiogroup:i(d.select,r)&&(n+='<option value="'+d.select+'" '+(r==d.select?'selected="selected"':"")+">"+s[d.select].t+"</option>"),i(d.radiogroup,r)&&(n+='<option value="'+d.radiogroup+'" '+(r==d.radiogroup?'selected="selected"':"")+">"+s[d.radiogroup].t+"</option>");break;case d.multipleselect:case d.checkboxgroup:i(d.multipleselect,r)&&(n+='<option value="'+d.multipleselect+'" '+(r==d.multipleselect?'selected="selected"':"")+">"+s[d.multipleselect].t+"</option>"),i(d.checkboxgroup,r)&&(n+='<option value="'+d.checkboxgroup+'" '+(r==d.checkboxgroup?'selected="selected"':"")+">"+s[d.checkboxgroup].t+"</option>");break;default:n+='<option value="'+r+'" selected="selected">'+s[r].t+"</option>"}l.html(n).change(function(){(this.value==d.radiogroup||this.value==d.select)&&x.find('input[type="radio"][value="0"]').closest("tr").toggle(this.value==d.select)})}else{if(o.types_allowed.length>0)for(var c in o.types_allowed)o.types_allowed.hasOwnProperty(c)&&(n+='<option value="'+o.types_allowed[c]+'">'+s[o.types_allowed[c]].t+"</option>");else for(var c in d)d.hasOwnProperty(c)&&(n+='<option value="'+d[c]+'">'+s[d[c]].t+"</option>");l.html(n).change(function(){T=!1,h(this.value,!1,!1)}),l.val(r=intval(t&&t.type?t.type:l.val()))}return a&&1==o.types_allowed.length&&l.parent().parent().hide(),r}function h(l,n,r){l=intval(l),j.html(""),a||(t(l)?(n&&1==n.is_search?O.prop("checked",!0):O.prop("checked",!1),n&&1==n.search_hidden?C.prop("checked",!0):C.prop("checked",!1),P.removeClass("hidden")):(O.prop("checked",!1),P.addClass("hidden")),n&&1==n.req?S.prop("checked",!0):S.prop("checked",!1));var s="",c=e(l);switch((c||l==d.radio)&&(c&&(s+='<table class="multi-fields-block"><tr class="hdr nodrag nodrop"><th width="10" style="height:1px;"></th><th width="220" style="height:1px;" colspan="2"></th></tr></table><input type="button" class="btn btn-mini button submit multi-add" value="'+i.lang.add_val+'" style="margin-left:25px;" />'),$(".multi-default-clear",D).click(function(e){nothing(e),$(".dynprop-params input[type=radio], .dynprop-params input[type=checkbox]",D).prop("checked",!1)})),g(l)?(z.unbind().click(function(){var e=$(this).is(":checked");e?($(".parent-child-link",D).css("display","inline-block"),M.show()):($(".parent-child-link",D).hide(),M.hide()),T=e}),T?($(".parent-child-link",D).css("display","inline-block"),M.show(),z.prop("checked",!0).parent().show()):(z.prop("checked",!1).parent().show(),M.hide())):(z.prop("checked",!1).parent().hide(),M.hide()),l){case d.text:s+='<input type="text" name="dynprop[default_value]" class="input-xlarge" value="'+(n?n.default_value:"")+'" /></div>';break;case d.textarea:s+='<textarea name="dynprop[default_value]" >'+(n?n.default_value:"")+"</textarea></div>";break;case d.wysiwyg:s+='<textarea name="dynprop[default_value]" >'+(n?n.default_value:"")+"</textarea></div>",m("dynprop[default_value]");break;case d.radio:s+='<label class="radio inline"><input type="radio" name="dynprop[default_value]" value="2" '+(n&&"2"==n.default_value?'checked="checked"':"")+" />"+i.lang.yes+'</label><label class="radio inline"><input type="radio" name="dynprop[default_value]" value="1" '+(n&&"1"==n.default_value?'checked="checked"':"")+" />"+i.lang.no+"</label></div>";break;case d.checkbox:s+='<label class="checkbox"><input type="checkbox" name="dynprop[default_value]" style="height:18px;" '+(n&&n.default_value?'checked="checked"':"")+' value="1" /></label>',g(l)&&(s+='<a class="parent-child-link but sett '+(r?"":" disabled")+'" title="'+i.lang.add_child+'" href="#" style="margin-left:6px; display:none;" onclick="return '+w+".child("+(n?n.value:0)+", "+!r+');"></a>'),s+="</div>";break;case d.select:case d.multipleselect:case d.radiogroup:case d.checkboxgroup:var p=1;if((l==d.radiogroup||l==d.checkboxgroup)&&(s+='<br /><br /><label class="checkbox"><input type="checkbox" value="1" name="dynprop[group_one_row]" '+(n&&1==intval(n.group_one_row)?'checked="checked"':"")+" /> "+i.lang.group_one_row+"</label>"),j.html(s),x=$(".multi-fields-block",j),l==d.select&&!n&&!a){var u={value:0};if(o.langs)for(var h in o.langs)u["name_"+h]=i.lang.null_val;else u.name=i.lang.null_val;v(0,u,"",l,0)}if(n&&n.multi){for(var f in n.multi)p=Math.max(p,n.multi[f].value),v(p,n.multi[f],n.default_value,l,0);l==d.radiogroup&&x.find('input[type="radio"][value="0"]').closest("tr").hide()}else v(p,null,"",l,1);return $("input.multi-add",j).click(function(){v(++p,null,"",l,1,!0),x.tableDnDUpdate()}),void bff.rotateTable(x,!1);case d.number:case d.range:s+='<input type="text" name="dynprop[default_value]" value="'+(n?n.default_value:"")+'" />',g(l)&&(s+='<a class="parent-child-link but sett '+(r?"":" disabled")+'" title="'+i.lang.add_child+'" href="#" style="margin-left:6px;'+(T?"":" display:none;")+'" onclick="return '+w+".child(0, "+!r+');"></a>'),l==d.range&&(s+="<br /><br />"+i.lang.dia_from+':&nbsp;<input name="dynprop[start]" type="text" style="width:90px;" value="'+(n?n.start:"")+'" />&nbsp;&nbsp;'+i.lang.dia_to+':&nbsp;<input name="dynprop[end]" type="text" style="width:90px;" value="'+(n?n.end:"")+'" />&nbsp;'+i.lang.dia_step+':&nbsp;<input name="dynprop[step]" style="width:40px;" type="text" value="'+(n?n.step:"")+'" /></div>'),s+="<div"+(o.search_ranges?"":' class="hidden"')+">",s+="<br/><br/><strong>"+i.lang.dia_search_ranges+"</strong>:";var _="";if(n&&n.search_ranges&&(n.search_ranges.length>0||$.isPlainObject(n.search_ranges)))for(var f in n.search_ranges){var b=n.search_ranges[f];_+='<tr><td><input type="hidden" name="dynprop[search_ranges]['+b.id+'][id]" value="'+b.id+'" />'+i.lang.dia_from+':&nbsp;<input name="dynprop[search_ranges]['+b.id+'][from]" type="text" style="width:110px;" value="'+b.from+'" />&nbsp;&nbsp;'+i.lang.dia_to+':&nbsp;<input name="dynprop[search_ranges]['+b.id+'][to]" type="text" style="width:110px;" value="'+b.to+'" /></td><td><a class="but up" title="'+i.lang.move_up+'" href="#" onclick="'+w+'.up($(this)); return false;"></a><a class="but down" title="'+i.lang.move_down+'" href="#" onclick="'+w+'.down($(this)); return false;"></a><a class="but del" title="'+i.lang.del+'" href="#" onclick="$(this).parent().parent().remove(); return false;"></a></td></tr>',F=Math.max(b.id,F)}s+='<table><tbody id="search_ranges">'+_+'</tbody></table><a href="#" class="but add but-text" onclick="'+w+'.addDiaSearchRange(); return false;" style="margin: 8px 0;">добавить диапазон</a>',s+='<br/><label class="checkbox"><input type="checkbox" name="dynprop[search_range_user]" id="search_range_user_check" '+(n&&1==intval(n.search_range_user)?'checked="checked"':"")+" /> "+i.lang.dia_search_range_user+"</label>",s+="</div>";break;case d.country:if(i.countries){var y='<select name="dynprop[default_value]">';for(var f in i.countries)i.countries.hasOwnProperty(f)&&(y+='<option value="'+i.countries[f].id+'" '+(n&&n.default_value==i.countries[f].id?'selected="selected"':"")+" >"+i.countries[f].title+"</option>");y+="</select></div>",s+=y}break;case d.state:if(i.states){var R='<select name="dynprop[default_value]">';for(var f in i.states)i.states.hasOwnProperty(f)&&(R+='<option value="'+i.states[f].abbr+'" '+(n&&n.default_value==i.states[f].abbr?'selected="selected"':"")+" >"+i.states[f].title+"</option>");R+="</select></div>",s+=R}break;case d.date:return s+='<input id="datepicker" type="text" /><input id="datepicker_timestamp" type="hidden" name="dynprop[default_value]" /></div>',j.html(s),void k("datepicker",n)}j.html(s)}function f(){var e=++F;$("#search_ranges",D).append('<tr><td><input type="hidden" name="dynprop[search_ranges]['+e+'][id]" value="'+e+'" />'+i.lang.dia_from+':&nbsp;<input name="dynprop[search_ranges]['+e+'][from]" type="text" style="width:110px;" value="" />                                 &nbsp;&nbsp;'+i.lang.dia_to+':&nbsp;<input name="dynprop[search_ranges]['+e+'][to]" type="text" style="width:110px;" value="" />                                 </td><td><a class="but up" title="'+i.lang.move_up+'" href="#" onclick="'+w+'.up($(this)); return false;"></a>                                 <a class="but down" title="'+i.lang.move_down+'" href="#" onclick="'+w+'.down($(this)); return false;"></a>                                 <a class="but del" title="'+i.lang.del+'" href="#" onclick="$(this).parent().parent().remove(); return false;"></a></td></tr>')}function v(e,t,n,r,s,c){switch(html='<tr class="'+(t&&0==t.value?"hdr nodrag nodrop":"")+(s?"dynamic":"")+'">',r){case d.multipleselect:case d.checkboxgroup:var p=n?n.split(";"):"";html+="<td>",html+='<label class="checkbox"><input name="dynprop[multi_default_value]['+(t?t.value:e)+']" '+(A&&s?'disabled="disabled"':"")+' title="'+i.lang.default_val+'" type="checkbox" value="'+(t?t.value:e)+'" '+(t&&l(t.value,p)?'checked="checked"':"")+" /></label>";break;case d.select:case d.radiogroup:html+='<td><label class="radio"><input name="dynprop[multi_default_value]" type="radio" value="'+(t?t.value:e)+'" '+(t&&t.value==n?'checked="checked"':"")+" /></label>"}if(html+="</td><td>",o.langs)for(var u in o.langs)html+='<input name="dynprop[multi]['+(t?t.value:e)+"]["+u+']" type="text" value="'+(t?t["name_"+u]:"")+'" class="input-large lang-field j-lang-form j-lang-form-'+u+(u!=o.lang_default?" displaynone":"")+'" />';else html+='<input name="dynprop[multi]['+(t?t.value:e)+']" type="text" value="'+(t?t.name:"")+'" class="input-large" />';html+="</td><td>",(a||!t||0!=t.value)&&(html+='<a class="but up" title="'+i.lang.move_up+'" href="#" onclick="'+w+'.up($(this)); return false;"></a><a class="but down" title="'+i.lang.move_down+'" href="#" onclick="'+w+'.down($(this)); return false;"></a><a class="but del" title="'+i.lang.del+'" href="#" onclick="return '+w+".del(this, "+(t?t.value:e)+", "+s+');"></a>'),g(r)&&(t&&0!=t.value||s)&&(html+='<a class="parent-child-link but sett '+(!A||s?" disabled":"")+'" title="'+i.lang.add_child+'" '+(T?"":'style="display:none;"')+' href="#" onclick="return '+w+".child("+(t?t.value:0)+", "+(!A||s?1:0)+');"></a>'),html+="</td></tr>",x.append(html),A&&s&&q.push(e),a&&$.fancybox.resize(),c&&!o.langs&&$('input[type="text"]:last',x).focus()}function _(e,t,l){if(!l&&!bff.confirm("sure"))return!1;if(2==x.find("tr").length)return!1;if($(e).parent().parent().remove(),l){if(A)for(var n in q)if(q[n]==t){q.splice(n,1);break}}else R.push(t);return a&&$.fancybox.resize(),!1}function b(e,t){return t?(bff.error(i.lang.child_add_after_save),y(0),!1):(bff.ajax(i.url_action_owner+"child",{parent_id:o.data.id,parent_value:e},function(e){e&&$.fancybox(e.form)}),!1)}function y(e,t){return 1>e||t?!1:(bff.ajax(i.url_action_owner+"rotate-child",{dynprop:t,child_id:e,child_action:"sort",child_order:"desc"},function(e){e&&bff.success("done")}),!1)}function g(e){return a?!1:o.types_allowed_parent&&o.types_allowed_parent.length>0?l(e,o.types_allowed_parent):!1}function m(e){var t=new FCKeditor(e);t.BasePath="/js/bff/admin/fcke2/",t.ToolbarSet="Average",t.ReplaceTextarea()}function k(e,t){var a=$("#"+e);a.datepicker(i.date),t&&(a.datepicker("setDate",new Date(1e3*t.default_value)),$("#"+e+"_timestamp").val(new Date(a.datepicker("getDate")).getTime()/1e3))}$.extend(i,p);var x,w="bffDynprops"+(a?"Child":"Main"),D=$("#"+w+"Form"),j=$(".dynprop-params",D),P=$(".dynprop-search-block",D),O=$("input.dynprop-search",D),C=$("input.dynprop-search-hidden",D),S=$("input.dynprop-req",D),T=o.data&&1==o.data.parent,z=$("input.dynprop-parent",D),M=$(".dynprop-parent-block",D),R=[],q=[],F=0,A=o.edit;D.submit(function(){return A&&($(".multi-deleted",D).val(R.join(",")),$(".multi-added",D).val(q.join(","))),a?(c||(c=!0,bff.ajax(i.url_action_owner+"child",D.serialize(),function(e){e&&$.fancybox.close(),c=!1})),!1):!0}),a&&$(".dynprop-delete",D).click(function(){bff.confirm("sure")&&($('input[name="child_act"]',D).val("del"),D.submit())});var B=u(o.data);return h(B,o.data,A),{up:r,down:n,del:_,child:b,addDiaSearchRange:f}}function l(e,t){for(var a in t)if(t[a]&&t[a]==e)return!0;return!1}function n(e){var t=e.parent().parent(),a=t.next("tr:not(.hdr)");a.length&&t.before(a)}function r(e){var t=e.parent().parent(),a=t.prev("tr:not(.hdr)");a.length&&t.after(a)}var i={lang:{yes:"Да",no:"Нет",move_up:"переместить вверх",move_down:"переместить вниз",add:"добавить",add_val:"добавить значение",del:"удалить",add_child:"прикрепить",null_val:"Select",child_add_after_save:"Возможность прикрепления будет доступна <strong>после сохранения свойства</strong>",default_val:"Значение по умолчанию",no_val:"без значения",dia_search_range_user:"пользовательский вариант",dia_search_ranges:"Диапазоны поиска",dia_from:"от",dia_to:"до",dia_step:"шаг",group_one_row:"Отображать в одну строку"},countries:{},states:{},date:{}},d={text:1,textarea:2,wysiwyg:3,radio:4,checkbox:5,select:6,multipleselect:7,radiogroup:8,checkboxgroup:9,number:10,range:11,country:12,state:13,date:14},s={1:{t:"Однострочное текстовое поле"},2:{t:"Многострочное текстовое поле"},3:{t:"Текстовый редактор"},4:{t:"Выбор Да/Нет"},5:{t:"Флаг"},6:{t:"Выпадающий список"},7:{t:"Список с мультивыбором (ctrl)"},8:{t:"Группа св-в с единичным выбором"},9:{t:"Группа св-в с множественным выбором"},10:{t:"Число"},11:{t:"Диапазон"},12:{t:"Страны"},13:{t:"Штаты"},14:{t:"Дата"}},c=!1;return{init:a}}();